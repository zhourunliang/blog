---
layout: post
title:  "MySQL中的锁"
date:   2019-04-22
tags: MySQL
---

# InnoDB
本文是基于InnoDB的存储引擎

# 乐观锁
用数据版本（Version）记录机制实现，这是乐观锁最常用的一种实现方式。
## 例子：
三个字段，分别是id,value、version
每次更新表中的value字段时，为了防止发生冲突，需要这样操作
```sql
update TABLE
set value=2,version=version+1
where id=#{id} and version=#{version};
```

# 悲观锁
## 共享锁
- 共享锁又称读锁 read lock，是读取操作创建的锁。
- 其他用户可以并发读取数据，但任何事务都不能对数据进行修改（获取数据上的排他锁），直到已释放所有共享锁。

## 排它锁
- 排他锁 exclusive lock（也叫writer lock）又称写锁。
- 若事务 1 对数据对象A加上X锁，事务 1 可以读A也可以修改A，其他事务不能再对A加任何锁，直到事物 1 释放A上的锁。这保证了其他事务在事物 1 释放A上的锁之前不能再读取和修改A。排它锁会阻塞所有的排它锁和共享锁

# 行锁
- 行锁又分共享锁和排他锁,由字面意思理解，就是给某一行加上锁，也就是一条记录加上锁。
- 注意：行级锁都是基于索引的，如果一条SQL语句用不到索引是不会使用行级锁的，会使用表级锁。

# 表锁
- innodb 的行锁是在有索引的情况下,没有索引的表是锁定全表的.

# 死锁（Deadlock） 
- 所谓死锁：是指两个或两个以上的进程在执行过程中，因争夺资源而造成的一种互相等待的现象，若无外力作用，它们都将无法推进下去。此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程。由于资源占用是互斥的，当某个进程提出申请资源后，使得有关进程在无外力协助下，永远分配不到必需的资源而无法继续运行，这就产生了一种特殊现象死锁。

## 参考资料
* [MySQL/InnoDB中，乐观锁、悲观锁、共享锁、排它锁、行锁、表锁、死锁概念的理解](https://segmentfault.com/a/1190000015815061)